import React, { useState, useEffect, useMemo } from 'react';
import { 
  Zap, Shield, User, Heart, TrendingUp, 
  Crown, Compass, Briefcase, Share2, 
  Calculator, Sparkles, MessageSquare, Loader2, RefreshCw, 
  BarChart3, Settings, UserPlus, Info, Calendar,
  LineChart, Target, Edit3, Mars, Venus, Printer, MessageCircle,
  FileText, Activity, Hash, Binary, ChevronRight, Layout,
  PackageCheck, Hexagon, Binary as BinaryIcon, Gauge
} from 'lucide-react';

/**
 * App - æˆ˜ç•¥çº§ç”Ÿå‘½å…¨æ¯ç»ˆç«¯ v3.8 (ä¿®å¤ WhatsApp ä¸æ•°æ®åŒ–ç‰ˆ)
 * é€‚é…ï¼šé˜¿ç›› (Castor) | AI é¡¾é—®ï¼šæ³¢ (Bo)
 * ä¿®å¤ï¼š
 * 1. æ‰¾å›äº†ä¸¢å¤±çš„ WhatsApp (MessageCircle) åˆ†äº«æŒ‰é’®ã€‚
 * 2. ä¼˜åŒ–äº†åˆ†äº«åˆ° WhatsApp çš„æ–‡å­—æ‘˜è¦ï¼ŒåŒ…å«å…«è§’é‡åŒ–è¯„åˆ†ã€‚
 */

const App = () => {
  // --- æ ¸å¿ƒè®¡ç®—å¼•æ“ ---
  const reduceNum = (n) => {
    if (!n) return 0;
    let num = Math.abs(parseInt(n));
    while (num > 9) {
      num = String(num).split('').reduce((acc, curr) => acc + parseInt(curr), 0);
    }
    return num;
  };

  const calculateFullMatrix = (y, m, d, analysisYear) => {
    const dStr = String(d).padStart(2, '0');
    const mStr = String(m).padStart(2, '0');
    const yStr = String(y);
    
    const d1 = parseInt(dStr[0]) || 0; const d2 = parseInt(dStr[1]) || 0;
    const m1 = parseInt(mStr[0]) || 0; const m2 = parseInt(mStr[1]) || 0;
    const yr1 = parseInt(yStr[0]) || 0; const yr2 = parseInt(yStr[1]) || 0;
    const yr3 = parseInt(yStr[2]) || 0; const yr4 = parseInt(yStr[3]) || 0;

    const A = reduceNum(d1 + d2); 
    const B = reduceNum(m1 + m2); 
    const C = reduceNum(reduceNum(yr1 + yr2) + reduceNum(yr3 + yr4)); 
    const D = reduceNum(A + B); 
    const E = reduceNum(B + C); 
    const F = reduceNum(D + E); 
    const G = reduceNum(A + D); 
    const H = reduceNum(C + E); 
    const I = reduceNum(D + F); 
    const J = reduceNum(E + F); 
    const K = reduceNum(I + J); 

    const personalYear = reduceNum(parseInt(analysisYear) + reduceNum(m) + reduceNum(d));

    // æ•°æ®åŒ–è¯„åˆ†é€»è¾‘ (åŸºäºå‘½ç†ç‰¹è´¨)
    const metrics = [
      { label: 'æ ¸å¿ƒèƒ½é‡', val: F * 11, desc: 'ä¸»å‘½æ ¼å¼ºåº¦' },
      { label: 'æˆ˜ç•¥é€»è¾‘', val: D * 11, desc: 'è¿‡ç¨‹ç­¹è°‹åŠ›' },
      { label: 'æ‰§è¡Œé€Ÿåº¦', val: A * 11, desc: '3å·çˆ†å‘åŠ›' },
      { label: 'ç¯å¢ƒé€‚åº”', val: C * 11, desc: 'å¤–éƒ¨å˜é€šæ€§' },
      { label: 'æƒ…æ„Ÿå…±é¸£', val: B * 11, desc: 'ç›´è§‰æ•é”åº¦' },
      { label: 'é£é™©æ§åˆ¶', val: personalYear === 4 ? 90 : 50, desc: 'å¹´åº¦é£æ§å€¼' },
      { label: 'æ™šå¹´åŠ¿èƒ½', val: H * 11, desc: 'é•¿æœŸå¢å€¼åŠ›' },
      { label: 'æ ¹åŸºåé•‡', val: K * 11, desc: 'å†…é©±ç¨³å®šæ€§' }
    ];

    return { 
      A, B, C, D, E, F, G, H, I, J, K, personalYear, metrics,
      steps: [
        { label: 'å¤©èµ‹æ ¹åº•(A)', val: A },
        { label: 'æƒ…æ„Ÿé©±åŠ¨(B)', val: B },
        { label: 'ä¸»å‘½æ ¸å¿ƒ(F)', val: F, highlight: true },
        { label: 'åé•‡åº•è•´(K)', val: K, highlight: true }
      ]
    };
  };

  // --- çŠ¶æ€ç®¡ç† ---
  const [profile, setProfile] = useState({
    name: 'Castor é˜¿ç››',
    gender: 'Male',
    birthYear: 1980,
    birthMonth: 9,
    birthDay: 30,
    targetYear: 2026 
  });
  
  const [isEditingName, setIsEditingName] = useState(false);
  const [aiLoading, setAiLoading] = useState(false);
  const [aiResponse, setAiResponse] = useState('');
  const [chatInput, setChatInput] = useState('');

  const results = useMemo(() => {
    return calculateFullMatrix(profile.birthYear, profile.birthMonth, profile.birthDay, profile.targetYear);
  }, [profile.birthYear, profile.birthMonth, profile.birthDay, profile.targetYear]);

  const flowYears = [2024, 2025, 2026, 2027, 2028, 2029, 2030];
  const birthYears = Array.from({ length: 80 }, (_, i) => 1950 + i);
  const months = Array.from({ length: 12 }, (_, i) => i + 1);
  const days = Array.from({ length: 31 }, (_, i) => i + 1);

  // --- è¾…åŠ©ï¼šåæ ‡è®¡ç®— ---
  const getOctagonPoints = (cx, cy, r) => {
    let pts = [];
    for (let i = 0; i < 8; i++) {
      let angle = (i * 45 - 90) * (Math.PI / 180);
      pts.push(`${cx + r * Math.cos(angle)},${cy + r * Math.sin(angle)}`);
    }
    return pts.join(' ');
  };

  const getRadarPoints = (cx, cy, maxR, metrics) => {
    let pts = [];
    metrics.forEach((m, i) => {
      let r = (m.val / 100) * maxR;
      let angle = (i * 45 - 90) * (Math.PI / 180);
      pts.push(`${cx + r * Math.cos(angle)},${cy + r * Math.sin(angle)}`);
    });
    return pts.join(' ');
  };

  // --- äº¤äº’é€»è¾‘ ---
  const callGemini = async (prompt, systemPrompt = "") => {
    setAiLoading(true);
    const apiKey = ""; 
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] }
        })
      });
      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
      setAiResponse(typeof text === 'object' ? JSON.stringify(text) : String(text || ""));
    } catch (err) { setAiResponse(`Error: ${err.message}`); }
    finally { setAiLoading(false); }
  };

  const handleChat = () => {
    if (!chatInput.trim() || !results) return;
    const prompt = `åˆ†ææŒ‡ä»¤: ${chatInput}ã€‚å½“å‰èƒŒæ™¯: ä¸»å‘½æ•° ${results.F}, åé•‡ç  ${results.K}, æµå¹´ ${profile.targetYear}ã€‚å…³æ³¨äº¤æ˜“å‘˜ä¸é’è®­æ•™ç»ƒçš„åŒé‡èº«ä»½ã€‚`;
    callGemini(prompt, "ä½ æ˜¯ä¸€ä½ç²¾é€šé‡‘èæˆ˜ç•¥çš„ç§äººé¡¾é—®æ³¢ (Bo)ã€‚");
    setChatInput('');
  };

  const handleAiAnalyze = () => {
    const prompt = `åˆ†æ 1980-09-30 ç”·æ€§çš„å…«è§’æ•°æ®åŒ–å‘½ç›˜ã€‚ä¸»å‘½ ${results.F}ã€‚é‡ç‚¹è¯´æ˜ 2026 æµå¹´ 4 å¯¹è‚¡ç¥¨ä»“ä½ç®¡ç†å’Œ U13 é¡¹ç›®çš„å¥‘åˆåº¦ï¼Œå¹¶åˆ†æç‹¸èŠ±çŒ« Money å¯¹ä¸»äººçš„æƒ…ç»ªå¢ç›Šã€‚`;
    callGemini(prompt, "è¯·æä¾›ä¸€ä»½æ•´é½ã€æ•°æ®å¯¼å‘çš„æˆ˜ç•¥æŠ¥å‘Šã€‚");
  };

  const handleWhatsAppShare = () => {
    const message = encodeURIComponent(
      `ğŸ“‘ *ALPHA MATRIX é‡åŒ–æŠ¥å‘Š: ${profile.name}* ğŸ“‘\n` +
      `----------------------------------\n` +
      `ğŸ”¢ ä¸»å‘½æ ¼: ${results.F} (${results.F === 3 ? 'çˆ†å‘æ´¾' : 'åˆ†ææ´¾'})\n` +
      `ğŸ”’ æ ¸å¿ƒåé•‡: ${results.K} | âš¡ æµå¹´: ${results.personalYear}\n` +
      `ğŸ“Š æ‰§è¡Œè¯„åˆ†: ${results.metrics[2].val} | é£æ§è¯„åˆ†: ${results.metrics[5].val}\n` +
      `----------------------------------\n` +
      `ğŸ’¡ æˆ˜ç•¥å»ºè®®: 2026 ä¸ºæ¶æ„å¹´ï¼Œç¨³æ‰ç¨³æ‰“ã€‚è¯¦ç»† PDF å·²å¯¼å‡ºã€‚`
    );
    window.open(`https://wa.me/?text=${message}`, '_blank');
  };

  const numMap = {
    3: { name: "åˆ›æ„", color: "bg-rose-500", text: "text-rose-400" },
    9: { name: "æ¢¦æƒ³", color: "bg-indigo-500", text: "text-indigo-400" },
    4: { name: "ç­–åˆ’", color: "bg-emerald-500", text: "text-emerald-400" }
  };

  return (
    <div className="min-h-screen bg-[#010308] text-slate-200 p-4 md:p-8 font-sans antialiased">
      <div className="max-w-6xl mx-auto flex flex-col gap-6">
        
        {/* Header Terminal - WhatsApp æŒ‰é’®å·²æ‰¾å› */}
        <div className="flex justify-between items-center border-b border-white/5 pb-6 no-print">
          <div className="flex items-center gap-4">
            <div className="p-3 bg-indigo-600/20 border border-indigo-500/30 rounded-2xl">
              <BinaryIcon className="text-indigo-400 animate-pulse" size={24} />
            </div>
            <div>
              <h1 className="text-xl font-black tracking-tight text-white uppercase italic">Quantified Holographic Matrix</h1>
              <p className="text-[10px] text-slate-500 font-mono tracking-widest uppercase">Bo Strategic Terminal v3.8</p>
            </div>
          </div>
          <div className="flex gap-2">
            {/* WhatsApp æŒ‰é’®æ¢å¤ */}
            <button onClick={handleWhatsAppShare} className="p-3 rounded-2xl bg-emerald-600 text-white shadow-lg hover:bg-emerald-500 transition-all shadow-emerald-500/20" title="åˆ†äº«æ‘˜è¦åˆ° WhatsApp">
              <MessageCircle size={20} />
            </button>
            <button onClick={() => window.print()} className="p-3 rounded-2xl bg-indigo-600 text-white shadow-lg hover:bg-indigo-500 transition-all scale-105">
              <Printer size={20} />
            </button>
            <button onClick={() => setIsEditingName(!isEditingName)} className="p-3 rounded-2xl border border-white/10 text-slate-400 hover:text-white transition-all">
              <Edit3 size={20} />
            </button>
          </div>
        </div>

        {/* æ‰“å°é¡µçœ‰ */}
        <div className="hidden only-print text-center border-b-4 border-slate-900 pb-8 mb-10">
          <h1 className="text-3xl font-black text-slate-900 uppercase">é˜¿ç›› (Castor) ç”Ÿå‘½å…¨æ¯é‡åŒ–åˆ†ææŠ¥å‘Š</h1>
          <p className="text-sm font-bold text-slate-600 mt-2">DOC-ID: CAST-MATRIX-0930 | YEAR: {profile.targetYear}</p>
        </div>

        {/* å¿«æ·è®¾ç½® */}
        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 no-print">
          <div className="lg:col-span-8 bg-slate-900/40 p-6 rounded-[2.5rem] border border-white/5 backdrop-blur-xl">
             <div className="flex justify-between items-center mb-6">
                <h3 className="text-[10px] font-bold text-indigo-400 uppercase tracking-widest flex items-center gap-2"><Settings size={12} /> Matrix Configuration</h3>
                <div className="flex bg-black/40 p-1 rounded-xl border border-white/5">
                  <button onClick={() => setProfile({...profile, gender: 'Male'})} className={`px-4 py-1.5 rounded-lg text-[10px] font-black transition-all ${profile.gender === 'Male' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-600'}`}>MALE</button>
                  <button onClick={() => setProfile({...profile, gender: 'Female'})} className={`px-4 py-1.5 rounded-lg text-[10px] font-black transition-all ${profile.gender === 'Female' ? 'bg-rose-600 text-white shadow-lg' : 'text-slate-600'}`}>FEMALE</button>
                </div>
             </div>
             <div className="grid grid-cols-3 gap-3">
                {['Year', 'Month', 'Day'].map((label, i) => (
                  <select key={label} value={profile[i === 0 ? 'birthYear' : i === 1 ? 'birthMonth' : 'birthDay']} onChange={(e) => setProfile({...profile, [i === 0 ? 'birthYear' : i === 1 ? 'birthMonth' : 'birthDay']: parseInt(e.target.value)})} className="bg-slate-950 border border-white/10 rounded-xl p-3 text-sm font-black focus:border-indigo-500 outline-none cursor-pointer">
                    {[birthYears, months, days][i].map(o => <option key={o} value={o}>{o}</option>)}
                  </select>
                ))}
             </div>
             <div className="mt-6 pt-4 border-t border-white/5 flex gap-2 overflow-x-auto no-scrollbar">
                {flowYears.map(y => (
                  <button key={y} onClick={() => setProfile({...profile, targetYear: y})} className={`shrink-0 px-5 py-2.5 rounded-xl text-xs font-black transition-all border ${profile.targetYear === y ? 'bg-emerald-600 border-emerald-400 text-white shadow-lg' : 'bg-slate-950 border-white/5 text-slate-500'}`}>{y}</button>
                ))}
             </div>
          </div>
          <div className="lg:col-span-4 bg-slate-900/20 p-6 rounded-[2.5rem] border border-white/5 flex flex-col justify-center items-center text-center">
            <h3 className="text-[10px] font-bold text-slate-500 uppercase mb-4">Flow Analysis</h3>
            <div className="text-7xl font-black text-emerald-400 tracking-tighter mb-2">{results.personalYear}</div>
            <p className="text-[9px] text-slate-500 uppercase font-black tracking-widest">{results.personalYear === 4 ? "SYSTEMS & DISCIPLINE" : "SHIFT"}</p>
          </div>
        </div>

        {/* å…¨æ¯å±•ç¤º */}
        <div id="report-content" className="grid grid-cols-1 lg:grid-cols-12 gap-6 items-stretch">
          
          <div className="lg:col-span-4 flex flex-col gap-6">
            <div className="bg-slate-900/60 p-8 rounded-[2.5rem] border border-white/10 shadow-2xl print:bg-white print:border-slate-300 print:text-slate-950">
               <div className="flex items-center gap-4 mb-8 pb-6 border-b border-white/5 print:border-slate-200">
                 <div className="w-16 h-16 rounded-3xl bg-slate-950 flex items-center justify-center border border-white/5 print:bg-slate-100">
                   {profile.gender === 'Male' ? <Mars className="text-blue-400 print:text-blue-700" size={32}/> : <Venus className="text-rose-400 print:text-rose-700" size={32}/>}
                 </div>
                 <div className="flex-1">
                    {isEditingName ? <input type="text" value={profile.name} onChange={(e) => setProfile({...profile, name: e.target.value})} onBlur={() => setIsEditingName(false)} className="bg-black/50 border border-indigo-500/30 rounded-lg px-2 py-1 text-xl font-black text-white w-full" autoFocus /> : <h2 className="text-2xl font-black tracking-tight print:text-slate-900 leading-tight">{profile.name}</h2>}
                    <p className="text-[10px] text-slate-500 font-mono mt-1 tracking-widest">Profile: Octagonal Model 3.8</p>
                 </div>
               </div>
               <div className="space-y-4">
                  {results.metrics.map((m, idx) => (
                    <div key={idx} className="flex flex-col gap-1.5">
                       <div className="flex justify-between items-center text-[10px] font-bold uppercase">
                          <span className="text-slate-500">{m.label}</span>
                          <span className="text-indigo-400">{m.val}%</span>
                       </div>
                       <div className="h-1.5 w-full bg-black/40 rounded-full overflow-hidden border border-white/5 print:bg-slate-100">
                          <div className={`h-full bg-indigo-500/60 transition-all duration-1000`} style={{ width: `${m.val}%` }}></div>
                       </div>
                    </div>
                  ))}
               </div>
            </div>

            <div className="bg-slate-900/40 p-6 rounded-[2.5rem] border border-white/5 print:bg-white print:border-slate-300">
              <div className="flex items-center gap-3 mb-4 text-rose-400">
                <Heart size={16} />
                <h3 className="text-[10px] font-black uppercase tracking-widest">Anchor Factor: Money</h3>
              </div>
              <p className="text-[11px] text-slate-400 leading-relaxed print:text-slate-800 italic">
                ç‹¸èŠ±çŒ« Money æä¾›çš„ç¨³æ€é¢‘ç‡å¯¹äº 3 å·çˆ†å‘æ€§èƒ½é‡è‡³å…³é‡è¦ã€‚ä½œä¸ºé«˜é¢‘äº¤æ˜“è€…ï¼Œè¿™æ˜¯æ‚¨çš„æƒ…ç»ªå¯¹å†²é¡¹ã€‚
              </p>
            </div>
          </div>

          {/* å…«è§’é‡åŒ–å›¾ */}
          <div className="lg:col-span-8 bg-slate-950 p-10 rounded-[3.5rem] border border-white/10 flex flex-col items-center justify-center relative print:bg-white print:border-slate-300 print:text-slate-950">
            <div className="relative w-[480px] h-[480px] flex items-center justify-center">
              <svg className="absolute inset-0 w-full h-full overflow-visible opacity-20 print:opacity-70" viewBox="0 0 100 100">
                <defs>
                   <linearGradient id="qGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stopColor="#4f46e5"/><stop offset="100%" stopColor="#ec4899"/></linearGradient>
                </defs>
                {[0.2, 0.4, 0.6, 0.8, 1.0].map(s => <polygon key={s} points={getOctagonPoints(50, 50, 48 * s)} fill="none" stroke="rgba(255,255,255,0.05)" strokeWidth="0.1" />)}
                <polygon points={getRadarPoints(50, 50, 48, results.metrics)} fill="url(#qGrad)" fillOpacity="0.2" stroke="url(#qGrad)" strokeWidth="1" />
              </svg>

              <div className="absolute z-10">
                 <div className={`w-32 h-32 rounded-[3rem] bg-slate-900 flex flex-col items-center justify-center text-white shadow-2xl border border-white/10 print:bg-white print:text-slate-900 print:border-slate-900`}>
                   <span className="text-6xl font-black leading-none">{results.F}</span>
                   <span className="text-[10px] font-bold uppercase mt-2 text-indigo-400">APEX</span>
                 </div>
              </div>

              {results.metrics.map((m, i) => {
                const a = (i * 45 - 90) * (Math.PI / 180);
                return (
                  <div key={i} className="absolute flex flex-col items-center" style={{ left: `${50 + 58 * Math.cos(a)}%`, top: `${50 + 58 * Math.sin(a)}%` }}>
                    <span className="text-[9px] font-black text-slate-500 uppercase">{m.label}</span>
                    <span className="text-xs font-black text-indigo-400">{m.val}</span>
                  </div>
                );
              })}
            </div>
          </div>
        </div>

        {/* æˆ˜ç•¥æŠ¥å‘Š */}
        <div className="flex flex-col gap-6 no-print">
           <div className="flex justify-between items-center">
              <h3 className="text-[10px] font-bold text-slate-500 uppercase tracking-[0.4em] flex items-center gap-2"><Sparkles size={14} className="text-indigo-400"/> Strategic Framework</h3>
              <button onClick={handleAiAnalyze} disabled={aiLoading} className="px-8 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest flex items-center gap-2 shadow-xl">
                {aiLoading ? <Loader2 className="animate-spin" size={16}/> : <Sparkles size={16}/>} æ‰§è¡Œé‡åŒ–è§£æ
              </button>
           </div>

           {aiResponse && (
             <div className="bg-slate-900/60 p-10 rounded-[3.5rem] border border-white/10 shadow-2xl print:bg-white print:border-slate-300 print:text-slate-950">
                <div className="text-[15px] text-slate-300 leading-[1.9] border-l-4 border-indigo-500/20 pl-10 print:text-slate-800 print:border-indigo-700 print:pl-6 font-serif italic print:font-sans print:not-italic">
                   {aiResponse.split('\n').map((para, i) => <p key={i} className="mb-6">{para}</p>)}
                </div>
             </div>
           )}
        </div>

        {/* ç»ˆç«¯ */}
        <div className="bg-slate-900/60 p-8 rounded-[3rem] border border-white/5 shadow-2xl no-print">
          <div className="flex gap-4">
            <input type="text" value={chatInput} onChange={(e) => setChatInput(e.target.value)} placeholder="å’¨è¯¢æ³¢ (Bo) å…³äº 2026 çš„å…·ä½“éƒ¨ç½²..." className="flex-grow bg-black/60 border border-white/10 rounded-2xl px-8 py-5 text-sm font-bold focus:border-indigo-500 outline-none text-white font-mono" onKeyDown={(e) => e.key === 'Enter' && handleChat()} />
            <button onClick={handleChat} disabled={aiLoading || !chatInput.trim()} className="px-10 bg-slate-800 hover:bg-indigo-600 text-white rounded-2xl font-black uppercase text-xs shadow-2xl transition-all">
              {aiLoading ? <Loader2 className="animate-spin" size={20} /> : 'PROCESS'}
            </button>
          </div>
        </div>
      </div>
      
      <style>{`
        @media print {
          body { background-color: white !important; color: black !important; padding: 0 !important; margin: 0 !important; }
          .no-print { display: none !important; }
          .only-print { display: block !important; }
          .min-h-screen { min-height: auto !important; height: auto !important; background: white !important; padding: 0 !important; }
          .max-w-6xl { max-width: 100% !important; width: 100% !important; margin: 0 !important; padding: 20px !important; }
          #report-content { display: grid !important; }
          svg line, svg polygon { stroke: #000 !important; opacity: 0.3 !important; }
          page-break-inside: avoid;
        }
        .only-print { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.2); border-radius: 10px; }
      `}</style>
    </div>
  );
};

export default App;
